{% extends "base.html" %}
{% load i18n %}
{% load core_tags %}
{% load thumbnail %}
{% load humanize %}
{% load cache %}
{% load author_tags %}
{% load markup %}

{% block pagetitle %}Welcome{% endblock %}

{% block title %}{% endblock %}
{% block subtitle %}Latest News from Around the World{% endblock %}

{% block extrajs %}
<script type='text/javascript'>
   $(window).load(function() {
       $('#featuredContent').orbit({ fluid: '16x8', directionalNav: false });
   });
</script>

<script>
    var latest_stream_timestamp={{ latest_stream_timestamp }};

    $(function() {
        /* Trigger initial fetch */
        get_updated_stream('activityfeed');
        setInterval( "get_updated_stream('activityfeed')", 300000  ); /* 10 minutes 600000; 5 minutes 300000*/

    })

    function get_updated_stream(streamid){
        stream = $('#' + streamid)
        $.getJSON('{% url "ajax-stream-updated" %}', { timestamp:latest_stream_timestamp},
               function(data) {
                    /* Iterate and add the new elements to the stream div */   
                    var length = data.items.length; 
                    while(length--){
                        stream.prepend( data.items[length] );
                        $(stream).find(':first').slideDown(600);
                        $(stream).find(':first').effect("highlight", {}, 2000);
                    }
                    
                    latest_stream_timestamp=data.timestamp
                    $("abbr.timeago").timeago();
               }
          )
    return false;
    }

    function show_summarised(summaryp){
        /* We do this via the p, then hide from the parent, so the enclosed area (including all the added items) is not a hotspot for clicking */
        summary = $(summaryp).parent()
        $(summary).children('p').hide();
        $(summary).find('li.activity-item').slideDown(600);
    }

</script>

{% endblock %}

{% block content %}

<div class="features">

<div class="row">        
{% with features|first as feature %}
<div class="large-8 columns feature-item">
    <div class="feature-item-image feature-item-image-large content-type-{{ feature|classname|lower }}" style="{% if feature.image %}background:center no-repeat url('{% thumbnail feature.image 360x200 upscale crop %}'){% endif %}">
        <div class="feature-item-type label-{{ feature|classname|lower }}">{{ feature|classname|capfirst }}</div>
        <a href="{{ feature.get_absolute_url }}"></a>
    </div>
<h4 class="feature-item-title"><a href="{{ feature.get_absolute_url }}">{{ feature }}</a></h4>
<div class="feature-item-snippet">{{ feature.tagline }}</div>
<div class="feature-item-meta">by <a href="{% url 'user-profile' username=feature.created_by.username %}">{{ feature.created_by.get_full_name }}</a>&nbsp;&nbsp;&nbsp;&nbsp;{{ feature.created_at|verybrieftimesince }} ago <span class="feature-item-meta-comments"><a href="{{ feature.get_absolute_url }}#disqus_thread">Comments</a></span></div>
</div>
{% endwith %}
<div class="large-4 columns"><div class="row">
{% for feature in features|slice:"1:3" %}
<div class="large-12 columns feature-item">
    <div class="feature-item-image feature-item-image-small content-type-{{ feature|classname|lower }}" style="{% if feature.image %}background:center no-repeat url('{% thumbnail feature.image 300x270 upscale crop %}'){% endif %}">
        <div class="feature-item-type label-{{ feature|classname|lower }}">{{ feature|classname|capfirst }}</div>
        <a href="{{ feature.get_absolute_url }}"></a>
    </div>
<h4 class="feature-item-title feature-item-title-small"><a href="{{ feature.get_absolute_url }}">{{ feature }}</a></h4>
<div class="feature-item-snippet feature-item-snippet-smaller">{{ feature.tagline }}</div>
<div class="feature-item-meta">by <a href="{% url 'user-profile' username=feature.created_by.username %}">{{ feature.created_by.get_full_name }}</a><span class="feature-item-meta-comments">{{ feature.created_at|verybrieftimesince }} ago</span><br /><span class="feature-item-meta-comments"><a href="{{ feature.get_absolute_url }}#disqus_thread">Comments</a></span></div>
</div>
{% endfor %}
</div></div>

</div>



{% for feature in features|slice:"3:" %}
    {% if forloop.counter|divisibleby:2 %}
    {% else %}
        <div class="row">        
    {% endif %}
        <div class="large-6 columns feature-item">
            <div class="feature-item-image content-type-{{ feature|classname|lower }}" style="{% if feature.image %}background:center no-repeat url('{% thumbnail feature.image 360x200 upscale crop %}'){% endif %}">
                <div class="feature-item-type label-{{ feature|classname|lower }}">{{ feature|classname|capfirst }}</div>
                <a href="{{ feature.get_absolute_url }}"></a>
            </div>
        <h4 class="feature-item-title"><a href="{{ feature.get_absolute_url }}">{{ feature }}</a></h4>
        <div class="feature-item-snippet feature-item-snippet-small">{{ feature.tagline }}</div>
        <div class="feature-item-meta">by <a href="{% url 'user-profile' username=feature.created_by.username %}">{{ feature.created_by.get_full_name }}</a>&nbsp;&nbsp;&nbsp;&nbsp;{{ feature.created_at|verybrieftimesince }} ago <span class="feature-item-meta-comments"><a href="{{ feature.get_absolute_url }}#disqus_thread">Comments</a></span></div>
    </div>

    {% if forloop.counter|divisibleby:2 %}
        </div>
    {% else %}
    {% endif %}
{% endfor %}

</div>

{% endblock %}

{% block sidebar_right %}

<div class="activityfeed" id="activityfeed">
   <div class="activity-header"><p>Activity stream</p></div>
  {% if stream %}
       {% for action in stream|slice:":25" %}
            {% if action.target %}
                {% include "actstream/_action.html" %}
            {% else %}
                {% if action.is_summary %}
                    {% with action as summary %}{% include "actstream/_action_summary.html" %}{% endwith %}
                {% endif %}
            {% endif %}
         {% endfor %}
{% endif %}
</div>

{% endblock %}


